name: üöÄ Frontend Deploy (Vite + React)

on:
  push:
    branches:
      - master
  workflow_dispatch:  # –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions

jobs:
  deploy:
    name: üì¶ Build & Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 25

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üåø Create .env before build
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env
          echo "VITE_APP_MODE=production" >> .env
          echo "‚úÖ Created .env file:"
          cat .env

      - name: üèóÔ∏è Build project
        run: npm run build

      # --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–±–æ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ---
      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Starting deployment..."

            # –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            rm -rf ~/deploy_tmp
            mkdir -p ~/deploy_tmp

      - name: üì§ Upload build folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "dist/*"
          target: "~/deploy_tmp"

      - name: ‚öôÔ∏è Finalize deployment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Starting deployment..."

            # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            mkdir -p ~/deploy_tmp

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É –∏ —Å–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
            if [ -d "/var/www/bom-processor" ]; then
              echo "üóÇÔ∏è Creating backup of current version..."
              sudo rm -rf /var/www/bom-processor_backup
              sudo mv /var/www/bom-processor /var/www/bom-processor_backup
            fi

            # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω–æ–≤—É—é —Å–±–æ—Ä–∫—É
            echo "üì¶ Moving new build to /var/www/bom-processor..."
            sudo rm -rf /var/www/bom-processor
            sudo mv ~/deploy_tmp/dist /var/www/bom-processor
  
            # –ù–∞–∑–Ω–∞—á–∞–µ–º –ø—Ä–∞–≤–∞
            sudo chmod -R 755 /var/www/bom-processor
            sudo chown -R www-data:www-data /var/www/bom-processor
  
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
            echo "üîÅ Restarting Nginx..."
            sudo systemctl restart nginx
  
            echo "‚úÖ Deployment completed successfully!"
