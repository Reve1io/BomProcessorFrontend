name: ðŸš€ Frontend Deploy (Vite + React)

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð· Ð²ÐºÐ»Ð°Ð´ÐºÐ¸ Actions

jobs:
  deploy:
    name: ðŸ“¦ Build & Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 25   # Vite Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Node 18 Ð¸Ð»Ð¸ 20

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      # --- Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ ---
      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."

            # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¿Ð°Ð¿ÐºÐ° Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
            rm -rf ~/deploy_tmp
            mkdir -p ~/deploy_tmp

      - name: ðŸ“¤ Upload build folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "dist/*"
          target: "~/deploy_tmp"

      - name: âš™ï¸ Finalize deployment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."

            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            mkdir -p ~/deploy_tmp

            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
            if [ -d "/var/www/bom-processor" ]; then
              echo "ðŸ—‚ï¸ Creating backup of current version..."
              sudo rm -rf /var/www/bom-processor_backup
              sudo mv /var/www/bom-processor /var/www/bom-processor_backup
            fi

            # ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ
            echo "ðŸ“¦ Moving new build to /var/www/bom-processor..."
            sudo rm -rf /var/www/bom-processor
            sudo mv ~/deploy_tmp/dist /var/www/bom-processor

            # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env, ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
            if [ ! -f "/var/www/bom-processor/.env" ]; then
              echo "ðŸŒ¿ Creating .env file..."
              sudo bash -c 'cat > /var/www/bom-processor/.env <<EOF
              VITE_BASE_URL=${{ secrets.VITE_BASE_URL }}
              EOF'
              else
              echo "âœ… .env already exists â€” keeping current version."
              fi
  
              # ÐÐ°Ð·Ð½Ð°Ñ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
              sudo chmod -R 755 /var/www/bom-processor
              sudo chown -R www-data:www-data /var/www/bom-processor
  
              # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx
              echo "ðŸ” Restarting Nginx..."
              sudo systemctl restart nginx
  
              echo "âœ… Deployment completed successfully!"
